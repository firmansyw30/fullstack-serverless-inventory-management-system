name: Deploy Frontend on Push

on:
 push:
   branches: [main] # Change to desired branch
   paths:
     - 'frontend/**'
     - '.github/workflows/deploy-frontend.yml'
 workflow_dispatch:

env:
 GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
 NODE_VERSION: '22.x'
 NODE_OPTIONS: '--max_old_space_size=4096'
 CLOUD_STORAGE_BUCKET: ${{ secrets.CLOUD_STORAGE_BUCKET }}
 REACT_APP_API_KEY: ${{ secrets.GCLOUD_API_KEY }}

jobs:
 deploy-frontend:
   name: Build and Deploy Frontend
   runs-on: ubuntu-latest
  
   steps:
     - name: Checkout code
       uses: actions/checkout@v3
    
     - name: Authenticate to Google Cloud
       uses: google-github-actions/auth@v1
       with:
         credentials_json: ${{ secrets.GCP_SA_KEY }}
    
     - name: Setup Terraform
       uses: hashicorp/setup-terraform@v2
       with:
         terraform_version: 1.5.0
         terraform_wrapper: false
    
     - name: Get Infrastructure Outputs
       id: infra
       working-directory: ./infrastructure
       run: |
        set -euo pipefail

          # Init Terraform
          terraform init -input=false

          # DEBUG: Cek apakah Terraform benar-benar melihat output
          echo "ðŸ” DEBUG: Listing all outputs..."
          terraform output || echo "âš ï¸ No outputs found command failed"

          # Ambil output dengan error handling yang lebih ketat
          # Kita gunakan grep untuk memastikan kita tidak mengambil text Warning
          API_URL=$(terraform output -raw api_gateway_url 2>/dev/null || true)
          
          # Cek validitas API_URL
          if [[ -z "$API_URL" ]] || [[ "$API_URL" == *"Warning"* ]]; then
            echo "âŒ Error: Output 'api_gateway_url' tidak ditemukan atau state kosong."
            echo "Pastikan 'terraform apply' sudah dijalankan untuk infrastruktur."
            exit 1
          fi

          FRONTEND_BUCKET=$(terraform output -raw frontend_bucket_name 2>/dev/null || true)
          FRONTEND_URL=$(terraform output -raw frontend_website_url 2>/dev/null || true)

          # Normalize FRONTEND_URL (remove trailing slash)
          FRONTEND_URL="${FRONTEND_URL%/}"

          echo "âœ… Outputs Found:"
          echo "API_URL: $API_URL"
          echo "BUCKET: $FRONTEND_BUCKET"

          # Write to GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_bucket_name=$FRONTEND_BUCKET" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
    
     - name: Setup Node.js
       uses: actions/setup-node@v3
       with:
         node-version: ${{ env.NODE_VERSION }}
         cache: 'npm'
         cache-dependency-path: frontend/package-lock.json
    
     - name: Configure Frontend with Real API Endpoint
       working-directory: ./frontend
       run: |
         echo "ðŸ”§ Injecting API Gateway URL into frontend..."
         cat > .env << EOF
         REACT_APP_API_ENDPOINT=${{ steps.infra.outputs.api_url }}
         REACT_APP_API_KEY=${{ secrets.GCLOUD_API_KEY }}
         EOF
         echo "âœ… Frontend configured:"
         cat .env
    
     - name: Install Dependencies
       working-directory: ./frontend
       run: npm ci
    
     - name: Build Frontend
       working-directory: ./frontend
       run: |
         echo "ðŸ—ï¸ Building frontend with real API endpoint..."
         npm run build
         echo "âœ… Build complete!"
    
     - name: Verify Build
       working-directory: ./frontend
       run: |
         if [ ! -d "build" ]; then
           echo "âŒ Build directory not found!"
           exit 1
         fi
         echo "âœ… Build directory contents:"
         ls -la build/ | head -20
    
     - name: Deploy to Cloud Storage
       working-directory: ./frontend
       run: |
         echo "ðŸš€ Deploying frontend to Cloud Storage..."
          gsutil -m rsync -r -d build/ gs://${{ secrets.CLOUD_STORAGE_BUCKET }}
         echo "âœ… Frontend deployed!"
    
     - name: Deployment Summary
       run: |
         echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
         echo "" >> $GITHUB_STEP_SUMMARY
         echo "### ðŸ“ URLs:" >> $GITHUB_STEP_SUMMARY
         echo "- **Frontend:** ${{ steps.urls.outputs.frontend_url }}/index.html" >> $GITHUB_STEP_SUMMARY
         echo "- **API Gateway:** ${{ steps.urls.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
         echo "" >> $GITHUB_STEP_SUMMARY
         echo "### ðŸ§ª Test Commands:" >> $GITHUB_STEP_SUMMARY
         echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
         echo "# Test API" >> $GITHUB_STEP_SUMMARY
         echo "curl ${{ steps.urls.outputs.api_url }}/v1/items" >> $GITHUB_STEP_SUMMARY
         echo "\`\`\`" >> $GITHUB_STEP_SUMMARY